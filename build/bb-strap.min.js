/*! bb-strap 2014-05-14 */
!function(a,b){"use strict";!function(b){"function"==typeof define&&define.amd?define(["jquery","underscore","backbone","mustache"],b):b(jQuery,_,Backbone,a.Mustache||null)}(function(c,d,e,f){var g=e.View.prototype,h=e.Collection.prototype,i=e.Model.prototype,j=e.Router.prototype,k=!1,l=!0,m=null,n=function(){};e.TemplateManager=function(){var a=this;a.$cache={},a.prefix="/templates/",a.suffix=".template.html",a.initialize.apply(a,arguments)},e.TemplateManager.prototype={initialize:n,loadAsync:function(a){var b=this.$cache,d=b[a]||c.get(this.url(a));return b[a]=d,d},url:function(a){return this.prefix+a+this.suffix},id:function(a){return a.replace(this.prefix,"").replace(this.suffix,"")},load:function(a,b,c){if(d.isArray(a))this.loads(a,b,c);else{var e=c||this;this.loadAsync(a).done(function(a){b.call(e,a)})}},loads:function(a,b,c){if(d.isString(a))this.load(a,b,c);else for(var e=a.length,f={},g=this,h=c||g,i=d.after(e,function(){b.call(h,f)}),j=function(a){var b=g.id(this.url);f[b]=a,i.call(h,f)},k=0;e>k;k++)this.loadAsync(a[k]).done(j)}},e.templateManager=new e.TemplateManager,e.Mediator={channels:{},clear:function(){return e.Mediator.channels={},this},subscribe:function(a,b,c,d){var f=e.Mediator.channels;return f[a]||(f[a]=[]),f[a].push({fn:b,context:c||this,once:d||k}),this},publish:function(a){var b=e.Mediator.channels;if(b[a])for(var c=[].slice.call(arguments,1),d=0;d<b[a].length;d++){var f=b[a][d];f.fn.apply(f.context,c),f.once&&(e.Mediator.unsubscribe(a,f.fn,f.context),d--)}return this},unsubscribe:function(a,b,c){if(0===arguments.length)return e.Mediator.clear();var d=e.Mediator.channels;if(d[a])if(1===arguments.length)d[a]=[];else for(var f=0;f<d[a].length;f++){var g=d[a][f];g.fn!==b||c&&g.context!==c||(d[a].splice(f,1),f--)}return this},subscribeOnce:function(a,b,c){return e.Mediator.subscribe(a,b,c,l)}},e.Mediator.pub=e.Mediator.publish,e.Mediator.sub=e.Mediator.subscribe,e.App=e.View.extend({el:"body",constructor:function(){var d=this;a.app=d,d.$window=c(a),d.$html=c("html"),d.$document=c(b),d.$body=c("body"),d.$html.addClass("js").removeClass("no-js");var e=a.location;d.url=e.protocol+"//"+e.host+e.pathname,g.constructor.call(d),d.preInit.apply(d,arguments),d.views=d.buildViews(),d.router=d.buildRouter(),d.onInit.apply(d,arguments)},preInit:n,buildViews:function(){return{}},buildRouter:function(){return m},onInit:n,events:{"click .js-link":"nav"},nav:function(a){a.preventDefault();var b=c(a.currentTarget).attr("href");return this.navigate(b)},navigate:function(a,b){var c=this.router;return c&&(d.isUndefined(b)&&(b=l),a=a.replace(this.url,""),c.navigate(a,{trigger:b})),this},replaceCurrentView:function(a,b){var c=this.views.current;return c&&d.isFunction(c.clear)&&(c.clear(),delete this.views.current),this.views.current=new a(b),this},scrollTop:function(a){return this.$window.scrollTop(a||0),this}}),e.StrapRouter=e.Router.extend({constructor:function(a){var b=a||{},f=b.content||"#content";if(this.$content=c(f),j.constructor.call(this),!e.history.started){var g={silent:k,pushState:l};e.history.start(d.extend(g,d.pick(b,"silent","pushState")))}},show:function(b,c){var d=c||{};return d.el=this.$content,a.app.replaceCurrentView(b,d).scrollTop(0),this}}),e.StrapView=e.View.extend({constructor:function(a){var b=this,c=a||{};d.each(c,function(a,c){b[c]=a}),b.$cache={},b.$subviews={},b.templateManager=e.templateManager,g.constructor.call(b,c);var f=[].slice.call(arguments,0);return d.isEmpty(f)&&(f=[{}]),b.onInit.apply(b,f),b.isEmpty()?b.postInit.apply(b,f):b.onReady.apply(b,f),b},onInit:n,subscriptions:{},delegateEvents:function(){return g.delegateEvents.apply(this,[].slice.call(arguments,0)),this.setSubscriptions()},undelegateEvents:function(){return g.undelegateEvents.apply(this,[].slice.call(arguments,0)),this.unsetSubscriptions()},setSubscriptions:function(a){var b=a||this.subscriptions;if(b&&!d.isEmpty(b)){this.unsetSubscriptions(b);var c=function(a,b){var c=!!a.once;d.isString(a)&&(a=this[a]),e.Mediator.subscribe(b,a,this,c)};d.each(b,c,this)}return this},unsetSubscriptions:function(a){var b=a||this.subscriptions;if(b&&!d.isEmpty(b)){var c=function(a,b){d.isString(a)&&(a=this[a]),e.Mediator.unsubscribe(b,a.$once||a,this)};d.each(b,c,this)}return this},isEmpty:function(){return!c.trim(this.$el.html())},isReady:function(){return l},postInit:function(){this.render()},onReady:n,$c:function(a){var b=this.$cache[a];return b||(b=this.$(a),this.$cache[a]=b),b},$read:function(b,c){if(a[b]){var d=c||b;this[d].set(a[b]),delete a[b]}return this},$$read:function(a){return this.$read("$$"+a,a)},$clear:function(){return this.$cache={},this},preRender:n,toJSON:n,$partials:function(a,b){var c={};return d.each(a,function(a,d){if(d!==b){var e=d.split("/");e=e[e.length-1],c[e]=a}}),c},partials:function(){return{}},onLoaded:function(a){var b=d.result(this,"toJSON");if(d.isString(a))this.populate(a,b||{});else{var c=d.result(this,"templates"),e=a[c[0]],f=this.$partials(a,c[0]);f=d.extend(f,this.partials(a,c[0])||{}),this.populate(e,b,f)}},render:function(){var a=d.result(this,"isReady");if(a){var b=d.result(this,"templates");if(b){var c=d.isArray(b)?"loads":"load";this.templateManager[c](b,this.onLoaded,this)}}return this},dispose:function(){var a=this;return a.onDispose(),a.$clear(),a.closeSubviews(),a.stopListening(),a.undelegateEvents(),this},destroy:function(){var a=this,b={$cache:l,$subviews:l,cid:l,$el:l,el:l};for(var c in a)if(d.has(a,c)&&!b[c]){var f=a[c];f instanceof e.StrapView&&f.close(),a[c]=m}return a},closeSubviews:function(){var a=this;d.each(a.$subviews,function(b){a.stopListening(b),b.close()}),a.$subviews={};for(var b in a){var c=a[b];d.has(a,b)&&c instanceof e.StrapView&&(c.close(),a[b]=m)}return a},onDispose:n,close:function(){var a=this;return a.trigger("close",a),a.dispose(),a.remove(),a.destroy(),a},clear:function(){var a=this;return a.trigger("clear",a),a.dispose(),a.$el.empty(),a.destroy(),a},populate:function(){var a=this,b=[].slice.call(arguments,0),c=a.toHtml.apply(a,b);return a.closeSubviews(),a.preRender(),a.$clear(),a.hideLoader(),a.$el.html(c),a.onReady(),a},toHtml:function(){return this.compileTemplate.apply(this,arguments)},compileTemplate:function(a,b){return d.template(a,b||{})},addSubview:function(a){this.$subviews||(this.$subviews={});var b=a;d.isArray(b)||(b=[b]);var c=function(a){this.$subviews[a.cid]=a,this.listenToOnce(a,"close",this.removeSubview)};return d.each(b,c,this),a},removeSubview:function(a){this.stopListening(a);var b=a.cid;return delete this.$subviews[b],this},$addSubview:function(a,b,c){var f=this;a instanceof e.$||(a=f.$c(a)),(d.isNull(c)||d.isUndefined(c))&&(c={});var g=c;d.isFunction(g)||(g=function(){return c});var h=[],i=function(a,c){var e=d.extend(g.call(f,a,c),{el:c}),i=new b(e);f.addSubview(i),h.push(i)};return a.each(i),1===h.length?h[0]:h},elLoader:"loading",iconLoader:"icon-loader",showLoader:function(){var a=this,b=a.$loader,e=d.result(a,"iconLoader"),f=d.result(a,"elLoader");return!b&&e&&(a.$loading=l,b=c("<i></i>").addClass(e),a.$el.addClass(f).html(b),a.$loader=b),this},hideLoader:function(){var a=this;if(a.$loader){a.$loading=k;var b=d.result(a,"elLoader");a.$el.removeClass(b),a.$loader.remove(),a.$loader=m}return this}}),e.MustacheView=e.StrapView.extend({compileTemplate:function(a,b,c){return f.to_html(a,b||{},c||{})}}),e.StrapCollection=e.Collection.extend({constructor:function(a,b){var c=this;c.$fetching=!1;var e=b||{};d.each(e,function(a,b){c[b]=a}),h.constructor.apply(c,arguments)},fetch:function(a){var b=this,c=m;if(!b.$fetching||a.force){b.$fetching=!0;var d=a||{},e=d.success,f=d.error,g=d.complete,i=function(a,c,h){g&&g(a,c,h),b.$fetching=!1,d=e=f=g=i=m},j=function(a,b,c,d){a&&a(b,c,d),i(b,c,d)};d.success=function(a,b,c){j(e,a,b,c)},d.error=function(a,b,c){j(f,a,b,c)},c=h.fetch.call(b,d)}return c}}),e.PaginatedCollection=e.StrapCollection.extend({constructor:function(a,b){var c=b||{},e=c.total;(d.isNull(e)||d.isUndefined(e))&&(e=Number.MAX_VALUE);var f=this;f.total=e,f.page=c.page||0,f.pageSize=c.pageSize||10,h.constructor.apply(f,arguments)},lastId:function(){return this.last().get("id")},nextPageById:function(a){this.next(a||{},{"next-id":this.lastId(),"page-size":this.pageSize})},nextPage:function(a){this.next(a,{page:this.page+1,"page-size":this.pageSize})},next:function(a,b){if(this.length<this.total){var c=a||{};c.data=d.extend(c.data||{},b),c.processDatas=l,c.remove=k,c.merge=k,c.add=l;var e=this,f=c.success;return c.success=function(b,c){e.page++,0===c.length&&(e.total=e.length),f&&f.apply(this,[].slice.call(arguments,0)),e.trigger("sync:page",b,c,a)},this.fetch(c)}}}),e.StrapModel=e.Model.extend({constructor:function(a,b){var c=this;c.$fetching=c.$saving=c.$destroying=k;var e=b||{};d.each(e,function(a,b){c[b]=a}),i.constructor.call(c,a,e)},fetch:function(a){return this.$sync(m,a,"fetch","$fetching")},save:function(a,b){return this.$sync(a,b,"save","$saving")},destroy:function(a){return this.$sync(m,a,"destroy","$destroying")},$sync:function(a,b,c,d){var f=this,g=m;if(!f[d]||b.force){f[d]=l;var h=b||{},i=h.complete,j=h.success,n=h.error,o=function(a,b,c){i&&i(a,b,c),f[d]=k,h=j=n=i=o=m},p=function(a,b,c,d){a&&a(b,c,d),o(b,c,d)};h.success=function(a,b,c){p(j,a,b,c)},h.error=function(a,b,c){p(n,a,b,c)};var q=[h];"save"===c&&q.unshift(a),g=e.Model.prototype[c].apply(f,q)}return g}})})}(window,window.document);